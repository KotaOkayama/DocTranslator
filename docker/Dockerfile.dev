FROM python:3.11-slim

# システムの依存関係をインストール
RUN apt-get update && apt-get install -y \
    wget \
    gnupg \
    curl \
    gcc \
    python3-dev \
    build-essential \
    libreoffice \
    xvfb \
    # PDFサポート用
    poppler-utils \
    # 画像処理用
    libmagic1 \
    # フォント
    fonts-ipafont \
    fonts-ipaexfont \
    fonts-noto-cjk \
    fonts-noto-cjk-extra \
    # ロケール
    locales \
    # その他の必要なツール
    git \
    && rm -rf /var/lib/apt/lists/*

# ロケールを設定
RUN sed -i -e 's/# ja_JP.UTF-8 UTF-8/ja_JP.UTF-8 UTF-8/' /etc/locale.gen && \
    locale-gen
ENV LANG ja_JP.UTF-8
ENV LANGUAGE ja_JP:ja
ENV LC_ALL ja_JP.UTF-8

# LibreOfficeの設定ディレクトリを作成
RUN mkdir -p /root/.config/libreoffice/4/user \
    && mkdir -p /tmp/libreoffice

WORKDIR /app

# 必要なPythonパッケージをグループ分けしてインストール
COPY requirements.txt ./

# 基本的な依存関係を先にインストール
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Excel関連の依存関係を最初にインストール
RUN pip install --no-cache-dir \
    openpyxl>=3.1.0 \
    et-xmlfile>=2.0.0 \
    pandas>=1.3.0

# Web framework関連の依存関係をインストール
RUN pip install --no-cache-dir \
    fastapi==0.104.1 \
    starlette==0.27.0 \
    uvicorn[standard]==0.24.0 \
    python-multipart==0.0.6 \
    websockets==12.0 \
    python-dotenv==1.0.0

# ドキュメント処理関連の依存関係をインストール
RUN pip install --no-cache-dir \
    python-pptx>=0.6.21 \
    python-docx>=0.8.11 \
    PyPDF2>=3.0.0 \
    pdfplumber>=0.9.0

# ユーティリティ関連の依存関係をインストール
RUN pip install --no-cache-dir \
    requests>=2.26.0 \
    tqdm>=4.62.0 \
    Pillow>=9.0.0 \
    python-magic>=0.4.27 \
    nltk>=3.8 \
    cryptography>=41.0.0 \
    prometheus-client>=0.17.0 \
    fonttools>=4.38.0 \
    httpx==0.24.1

# 開発用の依存関係をインストール
COPY requirements-dev.txt ./
RUN pip install --no-cache-dir -r requirements-dev.txt

# アプリケーションのコードをコピー
COPY . .

# 必要なディレクトリを作成し、権限を設定
RUN mkdir -p uploads downloads logs cache
RUN chmod -R 777 uploads downloads logs cache

# スタートアップスクリプトを作成
RUN echo '#!/bin/bash\n\
set -e\n\
echo "Starting DocTranslator..."\n\
echo "Starting Xvfb..."\n\
Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX &\n\
sleep 2\n\
echo "Testing LibreOffice..."\n\
libreoffice --version\n\
echo "Starting application..."\n\
exec uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload' > /start.sh \
    && chmod +x /start.sh

# 環境変数を設定
ENV DISPLAY=:99
ENV HOME=/tmp
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Tokyo

# ヘルスチェック
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

EXPOSE 8000

CMD ["/start.sh"]
